<html>
<head>
    <script>
        var server_url = "http://127.0.0.1:5000";
        var fileListing = [];
        function callPython(methodName, data, callback) {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200 && callback) {
                    callback(JSON.parse(this.responseText));
                }
            };
            var methodType = "GET";
            if (data) {
                methodType = "POST";
            }
            xmlhttp.open(methodType, server_url + "/" + methodName, true);
            xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xmlhttp.send(JSON.stringify(data));
        }
        function loadDirectory(data) {
            var dir = document.getElementById("directory");
            if (dir) {
                dir.innerText = "Directory: " + data['dirname'];
            }
            fileListing = data["files"];
            loadFilesIntoSelect(fileListing);
        }

        function loadFilesIntoSelect(files) {
            var filesElement = document.getElementById("files");

            // remove the existing values, if any
            for(var j = filesElement.options.length - 1 ; j >= 0 ; j--)
            {
                filesElement.remove(j);
            }

            for (var i = 0; i < files.length; i++) {
                var opt = files[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                filesElement.appendChild(el);
            }
        }

        function filterFiles(filterText) {
            if (filterText.length === 0) {
                loadFilesIntoSelect(fileListing);
                return;
            }

            var filteredFiles = [];
            var searchRegex = new RegExp(filterText, "i");
            for (var i = 0; i < fileListing.length; i++) {
                var filename = fileListing[i];
                var result = filename.search(searchRegex);
                if (result !== -1) {
                    filteredFiles.push(filename);
                }
            }

            loadFilesIntoSelect(filteredFiles);
        }

        function loadEPub(data) {
            window.location.href = server_url + data['toc'];
        }
    </script>
</head>
<body onload="javascript:callPython('getFilesInEpubsDir', null, loadDirectory);">
    <p id="directory">Directory: </p>
    <p>Files: <input type="text" id="filter" value="" oninput="javascript:filterFiles(this.value)"/></p>
    <select id="files" size="10" onchange="javascript:callPython('openEPub', {filename: this.value}, loadEPub)">

    </select>
</body>