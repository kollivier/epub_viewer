<html>
<head>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <link rel="stylesheet" href="css/bootstrap-treeview.min.css"/>
    <script src="js/jquery-3.2.1.js"></script>
    <script src="js/bootstrap-treeview.min.js"></script>
    <style type="text/css">
    ul {
        list-style: none;
    }
    .vertical-align {
        display: inline-block;
        vertical-align: middle;
        float: none;
    }
    </style>
    <script>
        var server_url = "http://127.0.0.1:5000";
        var fileListing = [];
        var currentSubdir = '';
        var dirTree = {};
        function callPython(methodName, data, callback) {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200 && callback) {
                    callback(JSON.parse(this.responseText));
                }
            };
            var methodType = "GET";
            if (data) {
                methodType = "POST";
            }
            xmlhttp.open(methodType, server_url + "/" + methodName, true);
            xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xmlhttp.send(JSON.stringify(data));
        }
        function loadDirectory(data) {
            var dir = document.getElementById("directory");
            if (dir) {
                dir.innerText = "Directory: " + data['dirname'];
            }
            dirTree = data['dir_tree'];
            loadTOC(data["dir_list"])
            currentSubdir = '';
            loadSubdirIntoSelect(currentSubdir);
        }

        function loadTOC(dirs) {
            var tocHtml = '';
            console.log("dirs = " + JSON.stringify(dirs));
            var depth = 0;
            var tree = [];
            var parentNodes = [];
            var previousNode = null;

            for (var i = 0; i < dirs.length; i++) {
                var dirName = subdir = dirs[i];
                var thisDepth = 1;
                if (dirName === '') {
                    dirName = "All";
                } else {
                    thisDepth = 1;
                    var slashes = subdir.match(/\//g);
                    if (slashes) {
                        thisDepth += slashes.length;
                    }
                    dirName = dirName.split("/").pop();
                }

                var thisNode = {
                    text: dirName,
                    tags: [dirTree[subdir].length],
                    subdir: subdir
                };

                console.log("subdir = " + subdir);

                // if we're a level deeper, that means the previous node
                // is this node's parent, so add it to the parentNodes stack.
                if (thisDepth > depth && previousNode) {
                    console.log("This is a subdir of the previous node, " + previousNode.text);
                    console.log("subdir = " + subdir);
                    console.log("thisDepth = " + thisDepth, ", previousDepth = " + depth);
                    parentNodes.push(previousNode);
                } else if (thisDepth < depth) {
                    parentNodes.pop();
                }

                if (parentNodes.length > 0) {
                    var parentNode = parentNodes[parentNodes.length-1];
                    console.log("Adding to parent node " + parentNode.text);
                    if (!parentNode.nodes) {
                        parentNode.nodes = [];
                    }
                    parentNode.nodes.push(thisNode);
                } else {
                    tree.push(thisNode);
                    parentNodes.push(thisNode);
                }

                previousNode = thisNode;
                depth = thisDepth;
            }

            console.log("tree = " + JSON.stringify(tree))
            $('#tree').treeview({data: tree, showTags: true});
            $('#tree').treeview('collapseAll', { silent: true });
            $('#tree').on('nodeSelected', function(event, data) {
              currentSubdir = data.subdir;
              loadSubdirIntoSelect(data.subdir);
            });
        }

        function loadSubdirIntoSelect(subdir) {
            loadFilesIntoSelect(dirTree[subdir]);
        }

        function loadFilesIntoSelect(files) {
            var filesElement = document.getElementById("files");

            // remove the existing values, if any
            for(var j = filesElement.options.length - 1 ; j >= 0 ; j--)
            {
                filesElement.remove(j);
            }

            for (var i = 0; i < files.length; i++) {
                var opt = files[i];
                var el = document.createElement("option");
                el.textContent = opt.split(/[/]/).pop();
                el.value = opt;
                filesElement.appendChild(el);
            }
        }

        function filterDirs(filterText) {
            if (filterText.length > 0) {
                $("#tree").treeview('search', [filterText, {
                    ignoreCase: true,     // case insensitive
                    exactMatch: false,    // like or equals
                    revealResults: true,
                }]);
            } else {
                $("#tree").treeview('clearSearch');
            }
        }

        function filterFiles(filterText) {
            if (filterText.length === 0) {
                loadSubdirIntoSelect(currentSubdir);
                return;
            }

            var filteredFiles = [];
            var searchRegex = new RegExp(filterText, "i");
            for (var i = 0; i < dirTree[currentSubdir].length; i++) {
                var filename = dirTree[currentSubdir][i].split(/[/]/).pop();
                var result = filename.search(searchRegex);
                if (result !== -1) {
                    filteredFiles.push(filename);
                }
            }

            loadFilesIntoSelect(filteredFiles);
        }

        function loadEPub(data) {
            window.location.href = server_url + data['toc'];
        }
    </script>
</head>
<body onload="javascript:callPython('getFilesInEpubsDir', null, loadDirectory);">
    <div class="row">
        <div class="col-md-4">
            <label for="dirFilter">Filter</label>
            <input type="text" id="dirFilter" class="form-control" value="" oninput="javascript:filterDirs(this.value)"/>
        </div>

        <div class="col-md-8">
            <label for="filter">Filter</label>
            <input type="text" id="filter" class="form-control" value="" oninput="javascript:filterFiles(this.value)"/>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <label for="tree">Categories</label>
            <div id="tree"></div>   
        </div>

        <div class="col-md-8">
            <label for="files">Files</label>
            <select id="files" size="10" class="form-control" onchange="javascript:callPython('openEPub', {filename: this.value}, loadEPub)">

            </select>
        </div>
    </div>
</body>
